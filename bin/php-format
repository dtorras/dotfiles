#!/bin/bash

# Zed passes buffer content on stdin and expects formatted output on stdout.
# {buffer_path} is passed as $1 for context (file extension, config lookup).

FILE="$1"
GLOBAL_PINT="/Users/david/.composer/vendor/bin/pint"

# Find project root by walking up from the file's directory
find_project_root() {
    local dir="$1"
    while [ "$dir" != "/" ]; do
        if [ -f "$dir/composer.json" ]; then
            echo "$dir"
            return
        fi
        dir="$(dirname "$dir")"
    done
}

PROJECT_ROOT=$(find_project_root "$(dirname "$FILE")")

# Write stdin to a temp file
TEMP=$(mktemp /tmp/php-format.XXXXXX.php)
cat > "$TEMP"

# Use project-local formatter if available, otherwise global pint
if [ -n "$PROJECT_ROOT" ] && [ -f "$PROJECT_ROOT/vendor/bin/pint" ]; then
    "$PROJECT_ROOT/vendor/bin/pint" "$TEMP" > /dev/null 2>&1
elif [ -n "$PROJECT_ROOT" ] && [ -f "$PROJECT_ROOT/vendor/bin/php-cs-fixer" ]; then
    cd "$PROJECT_ROOT"
    ./vendor/bin/php-cs-fixer fix --allow-risky=yes "$TEMP" > /dev/null 2>&1
else
    "$GLOBAL_PINT" "$TEMP" > /dev/null 2>&1
fi

cat "$TEMP"
rm -f "$TEMP"
